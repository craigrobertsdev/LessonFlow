@rendermode InteractiveServer
@using LessonFlow.Components.Shared
@using LessonFlow.Domain.Enums
@using LessonFlow.Shared.Interfaces.Persistence
@using LessonFlow.Shared
@using Radzen.Blazor

@page "/LessonPlanner/{Year:int}-{Month:int}-{Day:int}/{StartPeriod:int}"

@if (_loading)
{
    <LoadingSpinner Message="Loading lesson plan" />
    return;
}

<div class="mx-auto max-w-7xl p-4 space-y-6">
    <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
        <div class="flex flex-col gap-4 p-4 md:flex-row md:items-end md:justify-between">
            <div class="flex items-center gap-2">
                @if (IsInEditMode)
                {
                    <label for="subject-name" class="text-sm font-medium text-gray-700">Subject</label>
                    <select id="subject-name" value="@EditingLessonPlan!.SubjectName" @onchange="HandleSubjectTaughtChanged" class="block w-48 rounded-md border-gray-300 bg-white text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        @foreach (var subject in SubjectsTaught)
                        {
                            <option value="@subject.Name">@subject.Name</option>
                        }
                        <option value="nit">NIT</option>
                    </select>
                }
                else
                {
                    <p id="subject-name">@LessonPlan.Subject.Name</p>
                }
            </div>

            <div class="flex items-center gap-2">
                @if (IsInEditMode)
                {
                    <label for="number-of-periods" class="text-sm font-medium text-gray-700">Number of Periods</label>
                    <select id="number-of-periods" value="@EditingLessonPlan!.NumberOfPeriods" @onchange="HandleLessonDurationChange" class="block w-28 rounded-md border-gray-300 bg-white text-sm shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        @foreach (var count in AvailableLessonSlots)
                        {
                            <option value="@count">@count</option>
                        }
                    </select>
                }
                else
                {
                    <p id="number-of-periods">@LessonPlan.NumberOfPeriods</p>
                }
            </div>

            <div class="flex items-center gap-2 text-sm text-gray-600">
                <span id="lesson-date-label" class="font-medium">Date</span>
                <span id="lesson-date">@DateTime.Now.ToShortDateString()</span>
            </div>

            <div>
                @if (IsInEditMode)
                {
                    <Button Id="cancel-editing" OnClick="CancelEditing">Discard Changes</Button>
                    <Button Id="save-lesson-plan" OnClick="SaveChanges">Save</Button>
                }
                else
                {
                    <Button Id="edit-lesson-plan" OnClick="EditLessonPlan">Edit Lesson Plan</Button>
                }
            </div>

            <div class="flex items-center gap-2">
                <Button OnClick="PrintLessonText">
                    Save
                </Button>
            </div>
        </div>
    </div>

    @if (LessonPlan.PeriodType == PeriodType.Lesson)
    {
        <div id="lesson-plan-editor" class="grid grid-cols-1 gap-6 lg:grid-cols-3">
            <div class="lg:col-span-2">
                <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
                    <div class="p-4">
                        <RadzenHtmlEditor @bind-Value="LessonPlan.PlanningNotesHtml" Style="height: 100%;" />
                    </div>
                </div>
            </div>

            <div class="rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
                <h3 class="mb-2 text-sm font-semibold text-gray-800">Resources</h3>
                <div class="text-sm text-gray-600">Resources</div>
            </div>

            <div id="lesson-plan-todo-list">
                <ToDoList />
            </div>
        </div>
    }
    else
    {
        <div id="nit-editor" class="grid grid-cols-2 gap-6">
            <div id="nit-notes-section" class="col-start-1">
                <RadzenHtmlEditor @bind-Value="LessonPlan.PlanningNotesHtml" Style="height: 100%;" />
            </div>
            <div id="nit-todo-list" class="col-start-2">
                <TodoList />
            </div>
        </div>
    }

    <button @onclick="OpenModal">Open Modal</button>

    <ConfirmationDialog @ref="OverwriteConfirmationDialog" Title="Confirm Overwrite"
                        Message="The duration of this lesson now conflicts with lessons planned later in this day"
                        OnConfirm="@(() => _cancelSaveOperation = false)" OnCancel="@(() => _cancelSaveOperation = true)" />
</div>
